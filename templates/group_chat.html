{% extends "base.html" %}
{% block title %}Ph√≤ng Chat Chung{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto h-[calc(100vh-12rem)] flex flex-col">
    <div class="mb-4">
        <h1 class="text-2xl font-semibold tracking-tight text-foreground mb-2">üí¨ Ph√≤ng Chat Chung</h1>
        <p class="text-muted-foreground">Tr√≤ chuy·ªán v·ªõi t·∫•t c·∫£ gi√°o vi√™n trong h·ªá th·ªëng</p>
    </div>

    <!-- Chat Container -->
    <div class="flex-1 bg-white rounded-xl shadow-card border border-[hsl(240,5.9%,90%)] flex flex-col overflow-hidden">
        <!-- Messages Area -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4">
            {% for msg in messages %}
            <div class="flex {% if msg.sender_id == current_user.id %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-md">
                    <div
                        class="flex items-center gap-2 mb-1 {% if msg.sender_id == current_user.id %}justify-end{% endif %}">
                        <span class="text-xs font-medium text-muted-foreground">{{ msg.sender.full_name }}</span>
                        <span class="text-xs text-muted-foreground">{{ msg.created_at.strftime('%H:%M %d/%m') }}</span>
                    </div>
                    <div
                        class="px-4 py-2 rounded-lg {% if msg.sender_id == current_user.id %}bg-indigo-600 text-white{% else %}bg-accent text-foreground{% endif %}">
                        <p class="break-words">{{ msg.message }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Input Area -->
        <div class="border-t border-[hsl(240,5.9%,90%)] p-4">
            <div class="flex gap-3">
                <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..."
                    class="flex-1 px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 input-shadcn"
                    onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()"
                    class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition">
                    <i class="fas fa-paper-plane mr-2"></i> G·ª≠i
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let lastMessageId = {{ messages[-1].id if messages else 0 }};

    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();

        if (!message) return;

        fetch('/api/group_chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    appendMessage(data.message, true);
                    scrollToBottom();
                } else {
                    alert('L·ªói g·ª≠i tin nh·∫Øn: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn!');
            });
    }

    function appendMessage(msg, isOwn) {
        const container = document.getElementById('messages-container');
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'}`;

        messageDiv.innerHTML = `
        <div class="max-w-md">
            <div class="flex items-center gap-2 mb-1 ${isOwn ? 'justify-end' : ''}">
                <span class="text-xs font-medium text-muted-foreground">${msg.sender_name}</span>
                <span class="text-xs text-muted-foreground">${msg.created_at}</span>
            </div>
            <div class="px-4 py-2 rounded-lg ${isOwn ? 'bg-indigo-600 text-white' : 'bg-accent text-foreground'}">
                <p class="break-words">${msg.message}</p>
            </div>
        </div>
    `;

        container.appendChild(messageDiv);
        lastMessageId = msg.id;
    }

    function fetchNewMessages() {
        fetch('/api/group_chat/messages')
            .then(response => response.json())
            .then(data => {
                const newMessages = data.messages.filter(m => m.id > lastMessageId);
                newMessages.forEach(msg => {
                    appendMessage(msg, msg.sender_id === {{ current_user.id }});
            });
        if (newMessages.length > 0) {
            scrollToBottom();
        }
    })
    .catch (error => console.error('Error fetching messages:', error));
}

    // Scroll to bottom on load
    window.addEventListener('load', scrollToBottom);

    // Auto-refresh every 3 seconds
    setInterval(fetchNewMessages, 3000);
</script>
{% endblock %}