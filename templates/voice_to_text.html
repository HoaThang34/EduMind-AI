{% extends "base.html" %}

{% block title %}Voice-to-Text - Chuẩn hóa Nhận xét AI{% endblock %}

{% block content %}
<div class="animate-fade-in-up space-y-6">
    <!-- Header Area -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="stagger-item">
            <h2 class="text-2xl font-bold text-foreground tracking-tight">Hệ thống Voice-to-Text</h2>
            <p class="text-muted-foreground text-sm">Chuyển đổi giọng nói thành nhận xét sư phạm chuyên nghiệp bằng AI
            </p>
        </div>
        <div class="stagger-item flex items-center gap-2">
            <span class="badge badge-secondary py-1 px-3">
                <i class="fas fa-microchip mr-2 text-indigo-500"></i> Gemini 3 Flash
            </span>
        </div>
    </div>

    <!-- Feature Introduction -->
    <div class="glass-panel p-6 stagger-item bg-gradient-to-r from-indigo-50/50 to-white border-indigo-100">
        <div class="flex flex-col md:flex-row gap-6 items-center">
            <div
                class="w-16 h-16 rounded-2xl bg-indigo-600 flex items-center justify-center text-white text-3xl shadow-lg shadow-indigo-200 shrink-0">
                <i class="fas fa-magic"></i>
            </div>
            <div class="flex-1 space-y-2">
                <h3 class="text-lg font-bold text-indigo-900">Đây là gì?</h3>
                <p class="text-sm text-indigo-800/80 leading-relaxed">
                    Công cụ này giúp thầy cô **tiết kiệm thời gian** khi viết nhận xét cho học sinh. Thầy cô chỉ cần nói
                    những ý nghĩ thô, AI sẽ tự động chỉnh sửa lỗi chính tả, trau chuốt từ ngữ và chuyển hóa thành văn
                    bản sư phạm chuyên nghiệp, đầy tính khích lệ.
                </p>
                <div class="flex flex-wrap gap-4 pt-2">
                    <div class="flex items-center gap-2 text-xs font-medium text-emerald-700">
                        <i class="fas fa-check-circle"></i> Sửa lỗi chính tả
                    </div>
                    <div class="flex items-center gap-2 text-xs font-medium text-emerald-700">
                        <i class="fas fa-check-circle"></i> Trau chuốt câu từ
                    </div>
                    <div class="flex items-center gap-2 text-xs font-medium text-emerald-700">
                        <i class="fas fa-check-circle"></i> Giữ đúng ý nghĩa
                    </div>
                    <div class="flex items-center gap-2 text-xs font-medium text-emerald-700">
                        <i class="fas fa-check-circle"></i> Tiết kiệm 80% thời gian
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8 border-t border-indigo-100/50 pt-6">
            <div class="flex gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm shrink-0">
                    1</div>
                <div>
                    <h4 class="text-sm font-semibold text-foreground">Ghi âm hoặc Nhập liệu</h4>
                    <p class="text-xs text-muted-foreground mt-1">Nhấn biểu tượng micro và nói suy nghĩ của thầy cô về
                        học sinh.</p>
                </div>
            </div>
            <div class="flex gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm shrink-0">
                    2</div>
                <div>
                    <h4 class="text-sm font-semibold text-foreground">Chuẩn hóa AI</h4>
                    <p class="text-xs text-muted-foreground mt-1">Nhấn "Chuẩn hóa bằng AI" để robot thông minh xử lý văn
                        bản.</p>
                </div>
            </div>
            <div class="flex gap-3">
                <div
                    class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-sm shrink-0">
                    3</div>
                <div>
                    <h4 class="text-sm font-semibold text-foreground">Sao chép & Sử dụng</h4>
                    <p class="text-xs text-muted-foreground mt-1">Sao chép kết quả cuối cùng để dán vào sổ liên lạc hoặc
                        bảng điểm.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Input Section -->
        <div class="glass-panel p-6 stagger-item flex flex-col h-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold flex items-center gap-2">
                    <i class="fas fa-microphone text-red-500"></i> Nhập dữ liệu thô
                </h3>
                <div id="recording-status" class="hidden">
                    <span class="flex items-center gap-2 text-xs font-medium text-red-500">
                        <span class="relative flex h-2 w-2">
                            <span
                                class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                        </span>
                        Đang lắng nghe...
                    </span>
                </div>
            </div>

            <div class="relative flex-1 min-h-[300px]">
                <textarea id="raw-text"
                    class="input-shadcn w-full h-full min-h-[300px] resize-none p-4 pb-14 text-base focus:ring-2 focus:ring-indigo-500/20"
                    placeholder="Bắt đầu nói hoặc nhập nội dung nhận xét thô tại đây..."></textarea>

                <div class="absolute bottom-4 right-4 flex gap-2">
                    <button id="start-btn"
                        class="w-12 h-12 rounded-full bg-indigo-600 text-white shadow-lg shadow-indigo-200 flex items-center justify-center hover:bg-indigo-700 active:scale-95 transition-all group"
                        title="Bắt đầu ghi âm">
                        <i class="fas fa-microphone text-xl group-[.recording]:animate-pulse"></i>
                    </button>
                    <button id="stop-btn"
                        class="hidden w-12 h-12 rounded-full bg-red-500 text-white shadow-lg shadow-red-200 flex items-center justify-center hover:bg-red-600 active:scale-95 transition-all"
                        title="Dừng ghi âm">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
            </div>

            <div class="mt-4 flex items-center justify-between">
                <button id="clear-btn" class="btn-ghost text-xs">
                    <i class="fas fa-trash-alt mr-2"></i> Xóa nội dung
                </button>
                <button id="normalize-btn" class="btn-primary flex items-center gap-2">
                    <i class="fas fa-magic"></i> Chuẩn hóa bằng AI
                </button>
            </div>
        </div>

        <!-- Output Section -->
        <div class="glass-panel p-6 stagger-item flex flex-col h-full bg-indigo-50/30 border-indigo-100/50">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold flex items-center gap-2">
                    <i class="fas fa-sparkles text-amber-500"></i> Kết quả chuẩn hóa
                </h3>
                <button id="copy-btn" class="btn-outline py-1.5 px-3 text-xs flex items-center gap-2">
                    <i class="fas fa-copy"></i> Sao chép
                </button>
            </div>

            <div id="normalized-container"
                class="relative flex-1 min-h-[300px] bg-white rounded-lg border border-indigo-100 p-6 shadow-sm overflow-y-auto">
                <div id="empty-state"
                    class="h-full flex flex-col items-center justify-center text-center p-8 text-muted-foreground">
                    <div class="w-16 h-16 rounded-full bg-indigo-50 flex items-center justify-center mb-4">
                        <i class="fas fa-wand-magic-sparkles text-2xl text-indigo-300"></i>
                    </div>
                    <p class="text-sm">Văn bản chuẩn hóa sẽ xuất hiện tại đây sau khi bạn nhấn nút chuẩn hóa.</p>
                </div>

                <div id="loading-state" class="hidden h-full flex flex-col items-center justify-center text-center p-8">
                    <div
                        class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4">
                    </div>
                    <p class="text-indigo-600 font-medium animate-pulse">AI đang xử lý nhận xét...</p>
                </div>

                <div id="normalized-text"
                    class="hidden text-foreground leading-relaxed text-lg italic whitespace-pre-wrap"></div>
            </div>

            <div class="mt-4 p-4 rounded-lg bg-amber-50 border border-amber-100">
                <div class="flex gap-3">
                    <i class="fas fa-lightbulb text-amber-500 mt-1"></i>
                    <p class="text-xs text-amber-800 leading-normal">
                        <strong>Mẹo nhỏ:</strong> Bạn có thể nói lủng củng hoặc dùng ngôn ngữ thông thường, AI sẽ tự
                        động biến đổi chúng thành các cụm từ tinh tế và mang tính khích lệ học sinh hơn.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rawTextArea = document.getElementById('raw-text');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const clearBtn = document.getElementById('clear-btn');
        const normalizeBtn = document.getElementById('normalize-btn');
        const copyBtn = document.getElementById('copy-btn');
        const recordingStatus = document.getElementById('recording-status');
        const normalizedTextDiv = document.getElementById('normalized-text');
        const emptyState = document.getElementById('empty-state');
        const loadingState = document.getElementById('loading-state');

        let recognition;

        // Check if Web Speech API is supported
        if ('webkitSpeechRecognition' in window || 'speechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'vi-VN';

            recognition.onstart = () => {
                recordingStatus.classList.remove('hidden');
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
            };

            recognition.onend = () => {
                recordingStatus.classList.add('hidden');
                startBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
            };

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                rawTextArea.value = transcript;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                alert('Lỗi ghi âm: ' + event.error);
            };
        } else {
            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            startBtn.title = 'Trình duyệt không hỗ trợ Web Speech API';
            alert('Trình duyệt của bạn không hỗ trợ nhận diện giọng nói. Bạn có thể nhập văn bản thủ công.');
        }

        startBtn.addEventListener('click', () => {
            if (recognition) recognition.start();
        });

        stopBtn.addEventListener('click', () => {
            if (recognition) recognition.stop();
        });

        clearBtn.addEventListener('click', () => {
            rawTextArea.value = '';
        });

        normalizeBtn.addEventListener('click', async () => {
            const text = rawTextArea.value.trim();
            if (!text) {
                alert('Vui lòng nhập hoặc nói nội dung nhận xét!');
                return;
            }

            // Show loading
            emptyState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            normalizedTextDiv.classList.add('hidden');
            normalizeBtn.disabled = true;

            try {
                const response = await fetch('/api/normalize-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                const data = await response.json();

                if (data.normalized_text) {
                    normalizedTextDiv.textContent = data.normalized_text;
                    loadingState.classList.add('hidden');
                    normalizedTextDiv.classList.remove('hidden');
                } else {
                    throw new Error(data.error || 'Lỗi không xác định');
                }
            } catch (error) {
                console.error('Normalization error:', error);
                alert('Lỗi khi chuẩn hóa: ' + error.message);
                loadingState.classList.add('hidden');
                emptyState.classList.remove('hidden');
            } finally {
                normalizeBtn.disabled = false;
            }
        });

        copyBtn.addEventListener('click', () => {
            const text = normalizedTextDiv.textContent;
            if (!text) return;

            navigator.clipboard.writeText(text).then(() => {
                const originalIcon = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Đã sao chép';
                copyBtn.classList.replace('btn-outline', 'bg-green-500');
                copyBtn.classList.add('text-white');

                setTimeout(() => {
                    copyBtn.innerHTML = originalIcon;
                    copyBtn.classList.replace('bg-green-500', 'btn-outline');
                    copyBtn.classList.remove('text-white');
                }, 2000);
            });
        });
    });
</script>
{% endblock %}